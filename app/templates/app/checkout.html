{% extends 'base.html' %}
{% load static %}
{% block style %}
<!-- Add custom CSS styles if needed -->
{% endblock %}
<title>{% block title %}Checkout {% endblock %}</title>
{% block content %}
<div class="container">
    <div class="row mt-5">
        <div class="col-sm-6">
            <h4>Order Summary</h4>
            <hr>
            {% for item in cart_items %}
            <div class="card mb-2">
                <div class="card-body">
                  <input type="hidden" name="productid" id="productid" value="{{item.product.uid}}">
                    <img src="{{item.product.productimage.url}}" alt="{{item.product.heading}}" style="height: 160px;width: 160px;">
                    <br><br>
                    <h5>Product: {{item.product.heading}}</h5>
                    <p>Quantity: {{item.quantity}}</p>
                    <p>Price: {{item.total_cost}}</p>
                    <input type="hidden" id="productquantity" name="productquantity" value="{{item.quantity}}">
                </div>
            </div>
            {% endfor %}
            <p class="fw-bold">Total cost={{totalamount}}</p>
            <small>Term and Condition: Lorem ipsum dolor sit amet consectetur adipisicing elit. Mollitia, ullam saepe! Iure optio repellat dolor velit, minus rem. Facilis cumque neque numquam laboriosam, accusantium adipisci nisi nihil in et quis?</small>
        </div>
        <div class="col-sm-4 offset-sm-1">
            <h4>Select Shipping Address</h4>
            <hr>
            <form  action="/paymentdone"  id="payment-form">
                {% for ad in add %}
                <div class="card">
                    <div class="card-body">
                        <h5>{{ad.name}}</h5>
                        <p>{{ad.locality}}, {{ad.city}}, {{ad.state}} - {{ad.zipcode}}</p>
                    </div>
                </div>
                <div class="form-check mt-2 mb-5">
                  <input type="hidden" name="custdemail" id="custdemail" value="{{ad.user.email}}">
                    <input class="form-check-input" type="radio" name="custid" id="custadd{{forloop.counter}}" value="{{ad.id}}">
                    <label class="form-check-label fw-bold" for="custadd{{forloop.counter}}">
                        Address: {{forloop.counter}}
                    </label>
                </div>
                {% endfor %}
                <button type="submit" class="btn btn-warning mt-3 px-5 fw-bold">Cashon delivery</button>
                <button type="button" id="open-payment-modal" class="btn btn-warning mt-3 px-5 fw-bold">Pay Now</button>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap Modal for Payment -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Pay with Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="card-input">Payment Amount: ${{ totalamount }}</label>
              <br>
              <br>
              <div id="card-element"></div>
              <p id="card-error" role="alert"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" id="submit-payment" class="btn btn-primary">Submit Payment</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block payment-gateway %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var stripe = Stripe('pk_test_51MUAzUSFPHIKtSNjyNFzxrJF7SpT6YQWZ0okdIGrF1cfxXmTQPnYi05LkXbzVOaYoK718eYAgJl4kc64JsrA6Mxv00qv2ZnhXw');
        var elements = stripe.elements();


        // var card = elements.create('card', { style: style });
        var style = {
        base: {
            fontSize: '16px',
            color: '#32325d',
            '::placeholder': {
                color: '#aab7c4',
            },
        },
        invalid: {
            color: '#fa755a',
        },
    };

        var card = elements.create('card', {
        style: style,
        hidePostalCode: false, // Hide postal code field if not required
        iconStyle: 'solid', // Use solid icon style
        classes: {
            base: 'stripe-card',
            focus: 'stripe-focus',
            empty: 'stripe-empty',
            invalid: 'stripe-invalid',
        },
    });


        card.mount('#card-element');

        card.addEventListener('change', function(event) {
            var displayError = document.getElementById('card-error');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Open Stripe payment modal when "Pay Now" button is clicked
        document.getElementById('open-payment-modal').addEventListener('click', function() {
            var paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        });

        // Handle form submission inside Bootstrap modal
        document.getElementById('submit-payment').addEventListener('click', function() {
            var totalamount = "{{ totalamount }}";
            console.log(totalamount)
            var custdemail = document.getElementById('custdemail').value;
            var productid = document.getElementById('productid').value;
            console.log(productid)
            console.log(custdemail)
            var productquantity=document.getElementById('productquantity').value
            console.log(productquantity)
            stripe.createPaymentMethod({
                type: 'card',
                card: card,
            }).then(function(result) {
                if (result.error) {
                    var errorElement = document.getElementById('card-error');
                    errorElement.textContent = result.error.message;
                } else {
                    fetch("{% url 'paymentprocess' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_method_id: result.paymentMethod.id,
                            totalamount: totalamount,
                            custdemail: custdemail,
                            productid:productid,
                            productquantity:productquantity,
                        }),
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        if (data.success) {
                            // Redirect to success page or show success message
                            alert('Payment successful!');
                            window.location.href = "{% url 'success' %}"; // Redirect to success page
                        } else {
                            var errorElement = document.getElementById('card-error');
                            errorElement.textContent = data.error;
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock payment-gateway %}
